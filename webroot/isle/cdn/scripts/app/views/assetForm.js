define(["jquery","../Util","../NodeManager"],function(e,t,n){e(function(){function r(n){e("#modelDetails").remove();if(n=="")return;e("#msg-selModel").after('<div class="modelDetails speech-bubble speech-bubble-left" id="modelDetails"><div class="col1"><br />Loading model details <img class="vertical-align-children-middle" id="loading" src="'+t.rootdir+'cdn/images/loading_dark.gif" alt="loading animation" /><br /><br /></div></div>');var r={};r.categories=[],r.relationships=[],r.attributes=[],r.attachments=[];var i=e("#csrfToken").html();e.when(e.ajax({url:t.rootdir+"remoteInterface",headers:{"x-csrftoken":i},data:{model:"AssetModel",method:"getAll",filter:{cols:[{col:"id",val:n}]}},dataType:"json",dataFilter:t.parseJSON,error:function(t,n,r){return e("#modelDetails").html('<div class="col1 errorText">I\'m sorry.<br />Something went wrong ('+r+').<br />Feel free to <a class="feedbackLink" href="#">submit a bug report</a>.</div>'),!1},success:function(t,n,i){e.each(t.result.value.items,function(e,t){r.url=t.url,r.desc=t.desc,r.img=t.img,r.img_modified=t.img_modified})}}),e.ajax({url:t.rootdir+"remoteInterface",headers:{"x-csrftoken":i},data:{model:"AssetModelCategory",method:"getAll",filter:{cols:[{col:"model",val:n}]}},dataType:"json",dataFilter:t.parseJSON,error:function(t,n,r){return e("#modelDetails").html('<div class="col1 errorText">I\'m sorry.<br />Something went wrong ('+r+').<br />Feel free to <a class="feedbackLink" href="#">submit a bug report</a>.</div>'),!1},success:function(t,n,i){e.each(t.result.value.items,function(e,t){r.categories.push({id:t.category,category:t.Category_name})})}}),e.ajax({url:t.rootdir+"remoteInterface",headers:{"x-csrftoken":i},data:{model:"AssetModelRelation",method:"getAll",filter:{cols:[{col:"source",val:n},{col:"target",val:n}],separator:"OR"}},dataType:"json",dataFilter:t.parseJSON,error:function(t,n,r){return e("#modelDetails").html('<div class="col1 errorText">I\'m sorry.<br />Something went wrong ('+r+').<br />Feel free to <a class="feedbackLink" href="#">submit a bug report</a>.</div>'),!1},success:function(t,n,i){e.each(t.result.value.items,function(e,t){r.relationships.push({sourceId:t.source,source:t.Manufacturer_name+" "+t.AssetModel_model,relation:t.Relation_name,targetId:t.target,target:t.Manufacturer2_name+" "+t.AssetModel2_model})})}}),e.ajax({url:t.rootdir+"remoteInterface",headers:{"x-csrftoken":i},data:{model:"AssetModelAttribute",method:"getAll",filter:{cols:[{col:"model",val:n}]},order:[{colClass:"Attribute",col:"name"},{col:"id"}]},dataType:"json",dataFilter:t.parseJSON,error:function(t,n,r){return e("#modelDetails").html('<div class="col1 errorText">I\'m sorry.<br />Something went wrong ('+r+').<br />Feel free to <a class="feedbackLink" href="#">submit a bug report</a>.</div>'),!1},success:function(t,n,i){var s="",o="",u=1,a="";e.each(t.result.value.items,function(e,n){a="",n["Attribute_name"]==o?(u++,a=" #"+u):e<t.result.value.items.length-1&&n.Attribute_name===t.result.value.items[e+1].Attribute_name?(u=1,a=" #"+u):u=1,o=n.Attribute_name,s=n.AttributeType_abbr,s==null&&(n.Attribute_type>4?s=" "+n.AttributeType_unit:s=""),r.attributes.push({name:n.Attribute_name+a,value:n.value,unit:s})})}}),e.ajax({url:t.rootdir+"remoteInterface",headers:{"x-csrftoken":i},data:{model:"AssetModelAttachment",method:"getAll",filter:{cols:[{col:"model",val:n}]}},dataType:"json",dataFilter:t.parseJSON,error:function(t,n,r){return e("#modelDetails").html('<div class="col1 errorText">I\'m sorry.<br />Something went wrong ('+r+').<br />Feel free to <a class="feedbackLink" href="#">submit a bug report</a>.</div>'),!1},success:function(t,n,i){e.each(t.result.value.items,function(e,t){r.attachments.push({name:t.name,num:t.num,extension:t.extension})})}})).done(function(i,s,o,u,a){e("#modelDetails").html('<div class="col1">Model details loaded.</div>');var f='<div class="col1">';r.img!==null?f+='<a href="'+t.rootdir+"uploads/images/assetmodels/"+n+"."+r.img+"?ts="+(new Date(r.img_modified)).getTime()/1e3+'"><img class="thumbImg" src="'+t.rootdir+"uploads/images/assetmodels/thumbs/"+n+"."+r.img+"?ts="+(new Date(r.img_modified)).getTime()/1e3+'" alt="'+t.htmlEncode(r.desc)+'"/></a><br />':f+='<div class="noImage">No Image</div>',r.url!==null&&(f+='<a href="'+t.htmlEncode(r.url)+'" target="_blank">Website</a>'),f+="</div>",f+='<div class="col2"><h4>'+t.htmlEncode(r.desc)+"</h4>",e.each(r.attributes,function(e,n){f+="<p>"+t.htmlEncode(n.name)+':<span class="big-bold-italic"> '+t.htmlEncode(n.value)+t.htmlEncode(n.unit)+"</span></p>"}),f+="<p>Categories: ",r.categories.length>0?(e.each(r.categories,function(e,n){f+='<a href="'+t.rootdir+"assets?item=category&value="+n.id+'">'+t.htmlEncode(n.category)+"</a>, "}),f=f.substring(0,f.length-2)+""):f+='<span class="big-bold-italic">None</span>',f+="</p>",e.each(r.relationships,function(e,n){f+='<p><a href="'+t.rootdir+"assets?item=model&value="+n.sourceId+'">'+t.htmlEncode(n.source)+'</a> <span class="bold-italic">'+t.htmlEncode(n.relation)+'</span> <a href="'+t.rootdir+"assets?item=model&value="+n.targetId+'">'+t.htmlEncode(n.target)+"</a></p>"}),f+="<p>Attachments: ",r.attachments.length>0?(e.each(r.attachments,function(e,r){f+='<a href="'+t.rootdir+"download?item=model&value="+n+"&num="+r.num+"&extension="+r.extension+"&name="+r.name+'">'+r.name+"."+r.extension+"</a>, "}),f=f.substring(0,f.length-2)):f+='<span class="big-bold-italic">None</span>',f+="</p>",f+="</div>",e("#modelDetails").html(f)})}e("#selModel").val()!=""&&r(e("#selModel").val()),e("#selModel").change(function(t){r(e(this).val())});if(t.currentPage()!="assets/new"){var i=new n,s={itemName:"asset",modelName:"Asset",itemVal:e("#hidId").val(),postURL:"assets/"+e("#hidId").val(),successFunction:function(e,t,n){window.location="../assets"+querystring}};i.confirmDelete(s),s={modals:!1,fieldNames:[{asset:"hidAssetIdCO",location:"selLocationCO",purpose:"txtPurposeCO",finish:"txtFinishCO",notes:"txtaNotesCO"},{asset:"hidAssetIdCI",notes:"txtaNotesCI"},{asset:"hidAssetIdR",purpose:"txtPurposeR",notes:"txtaNotesR"},{asset:"hidAssetIdUR",notes:"txtaNotesUR"},{id:"hidId",model:"selModel",location:"selLocation",serial:"txtSerial",notes:"txtaNotes"}],limit:10,filter:{cols:[{col:"asset",val:e("#hidId").val()}]},order:[{col:"time",dir:"DESC"}],itemName:"transaction",getCallback:function(n,r){var i=n.items[0];if(n["count"]!=0&&i.TransactionType_name=="Check-out")if(i.User_uid==e("html").attr("data-user")){var s="";i.finish!==null&&(s=t.htmlEncode(e.format.date(t.parseDate(i.finish).toString(),"M/d/yyyy"))),e("#actionsSubSection").html('<button type="button" name="checkIn" data-asset="'+e("#hidId").val()+'" value="checkIn" id="checkIn" class="btn btn-warning" title="Due: '+s+'"><i class="icon-white icon-upload"></i> Check-in</button>')}else{var o="";o='<a href="'+t.rootdir+"assets?item=user&value="+t.htmlEncode(i.User_uid)+'">'+t.htmlEncode(i.User_name)+"</a>",i.User_email!=null&&(o+=' <a href="mailto:'+t.htmlEncode(i.User_email)+'" aria-label="send email to user"><i class="icon-envelope"></i></a>'),e("#actionsSubSection").html("Out to "+o)}else if(n["count"]!=0&&i.TransactionType_name=="Restrict")e("html").attr("data-role")>=ISLE_CONTRIBUTOR?e("#actionsSubSection").html('<button type="button" name="unRestrict" data-asset="'+e("#hidId").val()+'" value="unRestrict" id="unRestrict" class="btn btn-warning"><i class="icon-white icon-ok-circle"></i> Unrestrict</button>'):e("#actionsSubSection").html("Restricted");else if(e("html").attr("data-role")>ISLE_VIEWER){var u="";e("html").attr("data-role")>=ISLE_CONTRIBUTOR&&(u=' <button type="button" name="restrict" data-asset="'+e("#hidId").val()+'" value="restrict" id="restrict" class="btn"><i class="icon-remove-circle"></i> Restrict</button>'),e("#actionsSubSection").html('<button type="button" name="checkOut" data-asset="'+e("#hidId").val()+'" value="checkOut" id="checkOut" class="btn"><i class="icon-download"></i> Check-out</button>'+u)}r&&e("#actionsSubSection button").first().focus()},buildTable:function(n){var r="<thead><th>Time</th><th>Action</th><th>User</th><th>Location</th><th>Purpose</th><th>Est. Finish Date</th><th>Notes</th></thead><tbody>",i="";e.each(n.items,function(n,s){r+="<tr><td>"+t.htmlEncode(e.format.date(s.time,"M/d/yyyy h:mm a"))+"</td>",r+="<td>"+t.htmlEncode(s.TransactionType_name)+"</td>",s["User_email"]==null?i=t.htmlEncode(s.User_name):i='<a href="mailto:'+t.htmlEncode(s.User_email)+'">'+t.htmlEncode(s.User_name)+"</a>",r+="<td>"+i+"</td>",r+="<td>"+t.htmlEncode(s.Location_center)+" "+t.htmlEncode(s.Location_bldg)+"-"+t.htmlEncode(s.Location_room)+"</td>",r+="<td>"+t.htmlEncode(s.purpose)+"</td>",!s.finish||s["finish"].indexOf("00")==0?r+="<td></td>":r+="<td>"+t.htmlEncode(e.format.date(t.parseDate(s.finish).toString(),"M/d/yyyy"))+"</td>",r+="<td>"+t.htmlEncode(s.notes)+"</td></tr>"}),r+="</tbody>",e("#nodeTable").html(r)}},i.initialize(s),e("#"+s.fieldNames[0].finish).datepicker({showOn:"button",buttonImage:t.rootdir+"cdn/images/calendar.gif"}),e("#transData").slideUp(1),e("#VerColMenu li h4").on("click keypress",function(t){if(t.type=="click"||t.type=="keypress"&&t.which==13)e(this).children("span.expander").html()==="+"?e(this).children("span.expander").html("-"):e(this).children("span.expander").html("+"),e(this).next().slideToggle("fast")})}if(e("html").attr("data-role")>=ISLE_CONTRIBUTOR){var o=new n,u={fieldNames:{id:"id",center:"selCenter",bldg:"txtBldg",room:"txtRoom"},itemName:"location",addBtnId:"addLocationBtn",dialogId:"modalDialogLocation",formId:"modalFormLocation",hasTable:!1,duplicate:{field:"room",errorMsg:"This location already exists"},successCallback:function(n){e("#selLocation option").first().after('<option value="'+n.id+'">'+t.htmlEncode(n.center)+" "+t.htmlEncode(n.bldg)+"-"+t.htmlEncode(n.room)+"</option"),e("#selLocation").val(n.id),e("#selLocation").focus()}};o.initialize(u);var a={fieldNames:u.fieldNames,itemName:u.itemName,select:["center"],filter:{cols:[]}};e("#"+u.fieldNames.center).autocomplete(o.buildACOptions(a));var f={fieldNames:u.fieldNames,itemName:u.itemName,select:["bldg"],filter:{cols:["center"]}};e("#"+u.fieldNames.bldg).autocomplete(o.buildACOptions(f));var l={fieldNames:u.fieldNames,itemName:u.itemName,select:["room"],filter:{cols:["center","bldg"]}};e("#"+u.fieldNames.room).autocomplete(o.buildACOptions(l))}})})