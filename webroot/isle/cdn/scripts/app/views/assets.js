define(["jquery","../Util","../NodeManager"],function(e,t,n){e(function(){function c(t){var n=[];e.each(t,function(t){n.push(e(this).attr("data-id"))});var r=[];e.each(n,function(e,t){r.push({colClass:"AssetModelCategory",col:"category",val:t})});var i={cols:r,separator:"OR"};return i}function h(){r=f.props.options.urlVars,i=f.props.options.savedState,r.page=1,i.page=1;if(Modernizr.history){if(e("#searchBox").val()!=""){r.search=e("#searchBox").val();var n="assets"+t.createQueryString(r);i.filter[1]=p(e("#searchBox").val()),i.search=e("#searchBox").val()}else{r.search=undefined;var n="assets"+t.createQueryString(r);i.search=undefined,i.filter[1]=undefined}i.urlVars=r,window.history.pushState(i,"",n)}else e("#searchBox").val()!=""?r.search=e("#searchBox").val():r.search=undefined,window.location=t.rootdir+"assets"+t.createQueryString(r);f.props.options.filter[1]=i.filter[1],f.getItems()}function p(e){var t={};return t.cols=[{col:"serial",val:"%"+e+"%",operator:"LIKE"},{colClass:"AssetModel",col:"model",val:"%"+e+"%",operator:"LIKE"},{colClass:"AssetModel",col:"desc",val:"%"+e+"%",operator:"LIKE"},{colClass:"AssetModel",col:"series",val:"%"+e+"%",operator:"LIKE"},{colClass:"Manufacturer",col:"name",val:"%"+e+"%",operator:"LIKE"}],t.separator="OR",t}var r={},i={};i.filter=[],r.item=t.getParameterByName("item"),r.value=t.getParameterByName("value"),r.search=t.getParameterByName("search"),r.page=t.getParameterByName("page");var s=!1;if(r.item==="location"||(r.item==="model"||r.item==="category"||r.item==="manufacturer"||r.item==="user")&&parseInt(r.value))if(r.item==="category"){s=e('#VerColMenu span.selector[data-id="'+r.value+'"]'),s.addClass("bold-italic");var o=s.closest("li").find(".selector");i.category=r.value,i.filter[0]=c(o)}else if(r.item==="manufacturer")i.filter[0]={cols:[{colClass:"AssetModel",col:"mfr",val:parseInt(r.value)}]};else if(r.item==="user")i.filter[0]={cols:[{colClass:"User",col:"uid",val:parseInt(r.value)}]};else if(r.item==="location"){r.value=r.value.split(",");var u=[],a="";e.each(r.value,function(e,t){switch(e){case 0:a="center";break;case 1:a="bldg";break;case 2:a="room"}u.push({colClass:"Location",col:a,val:t})}),i.filter[0]={cols:u}}else i.filter[0]={cols:[{col:r.item,val:parseInt(r.value)}]};i.filter[1]=r.search==""?undefined:p(r.search),e("#searchBox").val(r.search),i.search=r.search,i.page=parseInt(r.page)>0?parseInt(r.page):1;var f=new n,l={modals:!1,rowClickHandler:function(n){var r=e(n.currentTarget).find("a#itemSelector");return r.length>0&&n.target.nodeName!="INPUT"&&n.target.nodeName!="LABEL"&&n.target.parentNode.nodeName!="LABEL"&&n.target.nodeName!="BUTTON"&&n.target.nodeName!="A"&&n.target.parentNode.nodeName!="A"&&(e(n.target).hasClass("checkone")||t.goTo(e(r.first()[0]).attr("href"))),!1},fieldNames:[{asset:"hidAssetIdCO",location:"selLocationCO",purpose:"txtPurposeCO",finish:"txtFinishCO",notes:"txtaNotesCO"},{asset:"hidAssetIdCI",notes:"txtaNotesCI"}],itemName:"asset",filter:i.filter,order:[{colClass:"AssetModel",col:"desc"},{colClass:"Custom",col:"unique_id"}],buildTable:function(n){var r="";e("html").attr("data-role")>ISLE_VIEWER&&(r='<th class="checkall center"><input type="checkbox" name="chkSelectAll" id="chkSelectAll" class="checkall" title="select all" aria-label="select all" value="" /></th>'),e("#nodeTable").html("<thead><th></th><th></th><th></th><th></th>"+r+"</thead><tbody></tbody>");var i="",s=0;e.each(n.items,function(n,r){s++,e("#nodeTable tbody").append(e('<tr><td class="pad0 height3 width5" id="thumbCol'+s+'"></td></tr>'));if(r.AssetModel_img!==null){e("#thumbCol"+s).append(e('<a id="thumbColLink'+s+'" href="'+t.rootdir+"uploads/images/assetmodels/"+r.model+"."+r.AssetModel_img+"?ts="+(new Date(r.AssetModel_img_modified)).getTime()/1e3+'"></a>'));var o=new Image;o.setAttribute("data-id",s),o.setAttribute("alt",t.htmlEncode(r.AssetModel_desc)),o.onload=function(){e(this).addClass("thumbImg"),this.width/this.height>=85/54?e(this).addClass("fillwidth"):e(this).addClass("fillheight");var t=e(this).attr("data-id");e("#thumbColLink"+t).empty().append(e(this))},o.src=t.rootdir+"uploads/images/assetmodels/thumbs/"+r.model+"."+r.AssetModel_img+"?ts="+(new Date(r.AssetModel_img_modified)).getTime()/1e3}e("#nodeTable tbody tr").last().append(e('<td><a id="itemSelector" href="'+t.rootdir+"assets/"+r.id+'">'+t.htmlEncode(t.abbreviate(r.AssetModel_desc,400))+"</a></td>"));var u="S/N: "+t.abbreviate(t.htmlEncode(r.serial),100);e("#nodeTable tbody tr").last().append(e("<td>"+u+"</td>"));if(r["Transaction_type"]==1)if(r["Transaction_User_uid"]==e("html").attr("data-user")){var a="";r.Transaction_finish!==null&&(a=t.htmlEncode(e.format.date(t.parseDate(r.Transaction_finish).toString(),"M/d/yyyy"))),e("#nodeTable tbody tr").last().append(e('<td><button type="button" name="checkIn" data-asset="'+r.id+'" value="checkIn" id="cico'+r.id+'" class="btn btn-mini btn-warning" title="Due: '+a+'"><i class="icon-white icon-upload"></i> Check-in</button></td>'))}else i='<a href="'+t.rootdir+"assets?item=user&value="+t.htmlEncode(r.Transaction_User_uid)+'">'+t.htmlEncode(r.Transaction_User_name)+"</a>",r["Transaction_User_email"]!=null&&(i+=' <a href="mailto:'+t.htmlEncode(r.Transaction_User_email)+'" aria-label="send email to user"><i class="icon-envelope"></i></a>'),e("#nodeTable tbody tr").last().append(e("<td>Out to "+i+"</td>"));else r["Transaction_type"]==3?e("#nodeTable tbody tr").last().append(e("<td>Restricted</td>")):e("html").attr("data-role")>ISLE_VIEWER?e("#nodeTable tbody tr").last().append(e('<td><button type="button" name="checkOut" data-asset="'+r.id+'" value="checkOut" id="cico'+r.id+'" class="btn btn-mini"><i class="icon-download"></i> Check-out</button></td>')):e("#nodeTable tbody tr").last().append(e("<td></td>"));e("html").attr("data-role")>ISLE_VIEWER&&e("#nodeTable tbody tr").last().append(e('<td class="center checkone"><input type="checkbox" class="checkone" value="'+r.id+'" id="check'+r.id+'" aria-label="select asset" /></td>'))})},urlVars:r,savedState:i,selectItems:!0};e("#VerColMenu ul").hide(),s&&e.each(s.parents("ul"),function(t){e(this).attr("id")!=="VerColMenu"&&(e(this).show(),e(this).prev(".item").children(".expander").html("-"))}),e("#VerColMenu span.expander").on("click keypress",function(t){if(t.type=="click"||t.type=="keypress"&&t.which==13)e(this).html()==="+"?e(this).html("-"):e(this).html("+"),e(this).closest("li").children("ul").first().slideToggle("fast")}),f.initialize(l),e("#showAll, #VerColMenu span.selector").on("click keypress",function(n){if(n.type=="click"||n.type=="keypress"&&n.which==13)if(Modernizr.history){e("#searchBox").val(""),e("#showAll, #VerColMenu span.selector").removeClass("bold-italic"),r.page=1,i.page=1;if(typeof e(this).attr("data-id")!="undefined"){r.item="category",r.value=e(this).attr("data-id"),r.search=undefined;var s="assets"+t.createQueryString(r);e(this).addClass("bold-italic");var o=e(this).closest("li").find(".selector");i.category=e(this).attr("data-id"),i.filter[0]=c(o),i.search=undefined,i.filter[1]=undefined}else{f.props.options.urlVars={},f.props.options.savedState={},r=f.props.options.urlVars,i=f.props.options.savedState;var s="assets"+t.createQueryString(r);i.filter=[]}i.urlVars=r,window.history.pushState(i,"",s),f.props.options.filter=i.filter,f.getItems()}else typeof e(this).attr("data-id")!="undefined"?window.location=t.rootdir+"assets?item=category&value="+e(this).attr("data-id"):window.location=t.rootdir+"assets"}),e("#"+l.fieldNames[0].finish).datepicker({showOn:"button",buttonImage:t.rootdir+"cdn/images/calendar.gif"}),e("#addItemBtn").focus(),e("#showAll").on("click keypress",function(e){(e.type=="click"||e.type=="keypress"&&e.which==13)&&e.preventDefault()}),e("#searchBtn").on("click keypress",function(e){if(e.type=="click"||e.type=="keypress"&&e.which==13)e.preventDefault(),h()}),e("#searchBox").on("keypress",function(e){e.type=="keypress"&&e.which==13&&(e.preventDefault(),h())}),window.onpopstate=function(t){if(t.state){e("#showAll, #VerColMenu span.selector").removeClass("bold-italic");if(typeof t.state.category!="undefined"){var n=e('#VerColMenu span.selector[data-id="'+t.state.category+'"]');n.addClass("bold-italic"),e.each(n.parents("ul"),function(t){e(this).attr("id")!=="VerColMenu"&&(e(this).show(),e(this).prev(".item").children(".expander").html("-"))})}typeof t.state.search!="undefined"?e("#searchBox").val(t.state.search):e("#searchBox").val(""),f.props.options.urlVars=t.state.urlVars,f.props.options.savedState=t.state,f.props.options.filter=t.state.filter,f.getItems()}else typeof f.props.retVal!="undefined"&&document.location.reload()};if(e("html").attr("data-role")>=ISLE_CONTRIBUTOR){var d=new n,v={fieldNames:{id:"id",center:"selCenter",bldg:"txtBldg",room:"txtRoom"},itemName:"location",addBtnId:"addLocationBtn",dialogId:"modalDialogLocation",formId:"modalFormLocation",hasTable:!1,duplicate:{field:"room",errorMsg:"This location already exists"},successCallback:function(n){e("#"+l.fieldNames[0].location+" option").first().after('<option value="'+n.id+'">'+t.htmlEncode(n.center)+" "+t.htmlEncode(n.bldg)+"-"+t.htmlEncode(n.room)+"</option"),e("#"+l.fieldNames[0].location).val(n.id),e("#"+l.fieldNames[0].location).focus()}};d.initialize(v),e("#"+v.dialogId).on("shown",function(){e(this).css("z-index",e(this).css("z-index")+20),e(".modal-backdrop").last().css("z-index",e(".modal-backdrop").css("z-index")+20),e(".modal-backdrop").first().hide()}),e("#"+v.dialogId).on("hidden",function(){e(".modal-backdrop").first().show()});var m={fieldNames:v.fieldNames,itemName:v.itemName,select:["center"],filter:{cols:[]}};e("#"+v.fieldNames.center).autocomplete(d.buildACOptions(m));var g={fieldNames:v.fieldNames,itemName:v.itemName,select:["bldg"],filter:{cols:["center"]}};e("#"+v.fieldNames.bldg).autocomplete(d.buildACOptions(g));var y={fieldNames:v.fieldNames,itemName:v.itemName,select:["room"],filter:{cols:["center","bldg"]}};e("#"+v.fieldNames.room).autocomplete(d.buildACOptions(y))}})})