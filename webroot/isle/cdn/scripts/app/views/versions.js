define(["jquery","../Util","../NodeManager"],function(e,t,n){e(function(){function h(t){var n=[];e.each(t,function(t){n.push(e(this).attr("data-id"))});var r=[];e.each(n,function(e,t){r.push({colClass:"Version",col:"version",val:t})});var i={cols:r,separator:"OR"};return i}var r=t.getParameterByName("action"),i=t.currentPage(),s=i;i.indexOf("/")>0&&(r=i.substring(i.indexOf("/")+1,i.length),i=i.substring(0,i.indexOf("/")+1));var o={},u={};u.filter=[],o.action=r;var a=!1,f=new RegExp(/^[0-9]+\.[0-9]+(\.[0-9]+)?$/);f.test(o.action)&&(u.category=o.action,u.filter[0]={cols:[{col:"version",val:o.action}]});var l=new n,c={fieldNames:{id:"hidId",version:"txtVersion",revision:"txtRevision",date:"txtDate",description:"txtaDescription"},itemName:"version",order:[{col:"version",dir:"DESC"}],filter:u.filter,buildTable:function(n){var r="<tbody>";e.each(n.items,function(n,i){r+="<tr><td><h3>Version "+t.htmlEncode(i.version)+"</h3>",r+="Posted: "+t.htmlEncode(e.format.date(t.parseDate(i.date).toString(),"MMMM d, yyyy"))+"<br />",r+="Revision: "+t.htmlEncode(i.revision)+"<br />",r+=i.description,r+="</td></tr>"}),r+="</tbody>",e("#nodeTable").html(r)},getCallback:function(n,r){e("#VerColMenu").html(""),e.ajax({url:t.rootdir+"remoteInterface",headers:{"x-csrftoken":e("#csrfToken").html()},data:{model:"Version",method:"getAll"},dataType:"json",dataFilter:t.parseJSON,error:function(t,n,r){return e("#VerColMenu").html('<div class="errorText">I\'m sorry.<br />Something went wrong ('+r+').<br />Feel free to <a class="feedbackLink" href="#">submit a bug report</a>.</div>'),!1},success:function(n,r,i){var s=n.result.value;e.each(s.items,function(n,r){n==0&&e("#VerColMenu").append('<li><a id="showAll" class="fontsize floatRight marginT6" href="'+t.rootdir+'versionhistory">show all</a><h4 class="inline-block">Versions</h4></li>');var i=o.action==r["version"]?" bold-italic":"";e("#VerColMenu").append('<li><span class="item"><span class="selector'+i+'" tabindex="0" role="button" data-id="'+r.version+'">'+t.htmlEncode(r.version)+"</span></span></li>")})}})}};l.initialize(c),e("#container").on("click keypress","#showAll, #VerColMenu span.selector",function(n){if(n.type=="click"||n.type=="keypress"&&n.which==13)if(Modernizr.history){e("#showAll, #VerColMenu span.selector").removeClass("bold-italic");if(typeof e(this).attr("data-id")!="undefined"){o.action=e(this).attr("data-id");var r=t.rootdir+"versionhistory/"+encodeURIComponent(o.action);e(this).addClass("bold-italic");var i=e(this).closest("li").find(".selector");u.category=encodeURIComponent(o.action),u.filter[0]=h(i)}else{l.props.options.urlVars={},l.props.options.savedState={},o=l.props.options.urlVars,u=l.props.options.savedState;var r=t.rootdir+"versionhistory";u.filter=[]}u.urlVars=o,window.history.pushState(u,"",r),l.props.options.filter=u.filter,l.getItems()}else typeof e(this).attr("data-id")!="undefined"?window.location=t.rootdir+"versionhistory/"+encodeURIComponent(e(this).attr("data-id")):window.location=t.rootdir+"versionhistory"}),e("#container").on("click keypress","#showAll",function(e){(e.type=="click"||e.type=="keypress"&&e.which==13)&&e.preventDefault()}),window.onpopstate=function(t){if(t.state){e("#showAll, #VerColMenu span.selector").removeClass("bold-italic");if(typeof t.state.category!="undefined"){var n=e('#VerColMenu span.selector[data-id="'+t.state.category+'"]');n.addClass("bold-italic"),e.each(n.parents("ul"),function(t){e(this).attr("id")!=="VerColMenu"&&(e(this).show(),e(this).prev(".item").children(".expander").html("-"))})}l.props.options.urlVars=t.state.urlVars,l.props.options.savedState=t.state,l.props.options.filter=t.state.filter,l.getItems()}else typeof l.props.retVal!="undefined"&&document.location.reload()}})})